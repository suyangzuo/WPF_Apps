<Window
    AllowsTransparency="True"
    Background="Transparent"
    FontFamily="{DynamicResource AppFontFamily}"
    Foreground="#FFFFFF"
    Height="450"
    MinHeight="400"
    MinWidth="800"
    Title="打字练习"
    Width="800"
    WindowStartupLocation="CenterScreen"
    WindowStyle="None"
    mc:Ignorable="d"
    x:Class="WPF_Typing.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:WPF_Typing"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:wc="clr-namespace:System.Windows.Shell;assembly=PresentationFramework"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <Window.Resources>
        <SolidColorBrush Color="#1A1A1A" x:Key="WindowBackgroundBrush" />
        <SolidColorBrush Color="#FFFFFF" x:Key="WindowTextBrush" />

        <!--  Menu horizontal inner padding (left,right)  -->
        <Thickness x:Key="MenuInnerPadding">8, 0</Thickness>

        <!--  菜单栏背景色  -->
        <SolidColorBrush Color="#1A1A1A" x:Key="MenuBackgroundBrush" />

        <!--  Menu-only font family (force Microsoft YaHei)  -->
        <FontFamily x:Key="MenuFontFamily">/WPF_Typing;component/Assets/Fonts/#Google Sans Code, Consolas, HarmonyOS Sans SC, 微软雅黑</FontFamily>

        <!--  Shared application font family (kept for other controls if needed)  -->
        <FontFamily x:Key="AppFontFamily">/WPF_Typing;component/Assets/Fonts/#Google Sans Code, Consolas, HarmonyOS Sans SC, 微软雅黑</FontFamily>

        <Style TargetType="TextBlock">
            <Setter Property="FontFamily" Value="{StaticResource AppFontFamily}" />
        </Style>

        <Style TargetType="Button" x:Key="WindowButtonStyle">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            Background="Transparent"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            x:Name="Border">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" TargetName="Border" Value="#555" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" TargetName="Border" Value="#777" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button" x:Key="CloseButtonStyle">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            Background="Transparent"
                            CornerRadius="0,10,0,0"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            x:Name="Border">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" TargetName="Border" Value="#E81123" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="MenuItem" x:Key="DarkMenuItemStyle">
            <Setter Property="Background" Value="#1A1A1A" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Height" Value="32" />
            <!--  force menu font family  -->
            <Setter Property="FontFamily" Value="{StaticResource MenuFontFamily}" />
            <!--  一级菜单字体大小（只影响顶层菜单项）  -->
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border
                            Background="#1A1A1A"
                            BorderBrush="Transparent"
                            BorderThickness="1"
                            Height="30"
                            x:Name="Border">
                            <Grid>
                                <ContentPresenter
                                    ContentSource="Header"
                                    Margin="10,0"
                                    VerticalAlignment="Center"
                                    x:Name="HeaderHost" />
                                <Popup
                                    AllowsTransparency="True"
                                    HorizontalOffset="-4"
                                    IsOpen="{TemplateBinding IsSubmenuOpen}"
                                    Placement="Bottom"
                                    VerticalOffset="6"
                                    x:Name="SubMenuPopup">
                                    <!--  Keep a single outer border for the submenu panel with rounded corners  -->
                                    <Border
                                        Background="#2D2D2D"
                                        BorderBrush="Transparent"
                                        BorderThickness="0"
                                        CornerRadius="4"
                                        Padding="4"
                                        x:Name="SubMenuBorder">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter Property="Background" TargetName="Border" Value="#135" />
                                <Setter Property="BorderBrush" TargetName="Border" Value="#2DB" />
                                <Setter Property="BorderThickness" TargetName="Border" Value="1" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Submenu items: remove per-item borders so parent SubMenuBorder provides the overall border  -->
        <Style TargetType="MenuItem" x:Key="DarkSubMenuItemStyle">
            <Setter Property="Background" Value="#2D2D2D" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Height" Value="30" />
            <Setter Property="FontFamily" Value="{StaticResource MenuFontFamily}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border
                            Background="#2D2D2D"
                            BorderBrush="Transparent"
                            BorderThickness="0"
                            Height="30"
                            x:Name="Border">
                            <Grid>
                                <ContentPresenter
                                    ContentSource="Header"
                                    Margin="8,0"
                                    VerticalAlignment="Center"
                                    x:Name="HeaderHost" />
                                <Popup
                                    AllowsTransparency="True"
                                    HorizontalOffset="8"
                                    IsOpen="{TemplateBinding IsSubmenuOpen}"
                                    Placement="Right"
                                    VerticalOffset="-4"
                                    x:Name="SubMenuPopup">
                                    <!--  For nested submenus keep their own panel border with rounded corners  -->
                                    <Border
                                        Background="#2D2D2D"
                                        BorderBrush="#2D2D2D"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Padding="8"
                                        x:Name="SubMenuBorder">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter Property="Background" TargetName="Border" Value="#259" />
                                <!--  do not show per-item border on highlight  -->
                                <Setter Property="BorderBrush" TargetName="Border" Value="Transparent" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Checkable submenu items: also remove per-item borders  -->
        <Style TargetType="MenuItem" x:Key="CheckableSubMenuItemStyle">
            <Setter Property="Background" Value="#2D2D2D" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Height" Value="30" />
            <Setter Property="FontFamily" Value="{StaticResource MenuFontFamily}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border
                            Background="#2D2D2D"
                            BorderBrush="Transparent"
                            BorderThickness="0"
                            Height="30"
                            x:Name="Border">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Border
                                    Background="Transparent"
                                    BorderBrush="Gray"
                                    BorderThickness="1"
                                    Grid.Column="0"
                                    Height="14"
                                    Margin="10,0,0,0"
                                    VerticalAlignment="Center"
                                    Width="14"
                                    x:Name="CheckMarkBox">
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="White"
                                        HorizontalAlignment="Center"
                                        Text="✓"
                                        VerticalAlignment="Center"
                                        Visibility="Collapsed"
                                        x:Name="CheckMark" />
                                </Border>
                                <ContentPresenter
                                    ContentSource="Header"
                                    Grid.Column="1"
                                    Margin="10,0"
                                    VerticalAlignment="Center"
                                    x:Name="HeaderHost" />
                                <Popup
                                    AllowsTransparency="True"
                                    HorizontalOffset="8"
                                    IsOpen="{TemplateBinding IsSubmenuOpen}"
                                    Placement="Right"
                                    VerticalOffset="-4"
                                    x:Name="SubMenuPopup">
                                    <Border
                                        Background="#2D2D2D"
                                        BorderBrush="#2D2D2D"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Padding="4"
                                        x:Name="SubMenuBorder">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter Property="Background" TargetName="Border" Value="#345" />
                                <Setter Property="BorderBrush" TargetName="Border" Value="Transparent" />
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Visibility" TargetName="CheckMark" Value="Visible" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="MenuItem" x:Key="SubMenuHeaderStyle">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Height" Value="30" />
            <Setter Property="FontFamily" Value="{StaticResource MenuFontFamily}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border
                            Background="Transparent"
                            BorderBrush="Transparent"
                            BorderThickness="0"
                            Height="30"
                            x:Name="Border">
                            <Grid>
                                <ContentPresenter
                                    ContentSource="Header"
                                    Margin="10,0"
                                    VerticalAlignment="Center"
                                    x:Name="HeaderHost" />
                                <Popup
                                    AllowsTransparency="True"
                                    HorizontalOffset="8"
                                    IsOpen="{TemplateBinding IsSubmenuOpen}"
                                    Placement="Right"
                                    x:Name="SubMenuPopup">
                                    <Border
                                        Background="#2D2D2D"
                                        BorderBrush="#2D2D2D"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Padding="4"
                                        x:Name="SubMenuBorder">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <!--  match hover background of other second-level menu items but keep no outer border  -->
                                <Setter Property="Background" TargetName="Border" Value="#259" />
                                <Setter Property="BorderBrush" TargetName="Border" Value="Transparent" />
                                <Setter Property="BorderThickness" TargetName="Border" Value="0" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <WindowChrome.WindowChrome>
        <WindowChrome
            CaptionHeight="0"
            CornerRadius="10"
            GlassFrameThickness="0"
            ResizeBorderThickness="5"
            UseAeroCaptionButtons="False" />
    </WindowChrome.WindowChrome>

    <Border
        Background="#1A1A1A"
        BorderBrush="#555"
        BorderThickness="1"
        CornerRadius="10">
        <Grid>
            <Grid
                Height="36"
                MouseLeftButtonDown="WindowTitleBar_MouseLeftButtonDown"
                Panel.ZIndex="10"
                VerticalAlignment="Top"
                x:Name="TitleBarGrid">
                <Border Background="#2D2D2D" CornerRadius="10,10,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Image
                            Grid.Column="0"
                            Height="20"
                            Margin="8,0,8,0"
                            SnapsToDevicePixels="True"
                            Source="pack://siteoforigin:,,,/Assets/Images/PNG/十指禅.png"
                            Stretch="Uniform"
                            VerticalAlignment="Center"
                            Width="20" />

                        <!--  Buttons remain in right column  -->
                        <StackPanel
                            Grid.Column="2"
                            HorizontalAlignment="Right"
                            Orientation="Horizontal"
                            Panel.ZIndex="10"
                            VerticalAlignment="Top">
                            <Button
                                Click="MinimizeButton_Click"
                                Content="–"
                                Focusable="True"
                                FontSize="16"
                                Height="36"
                                Style="{StaticResource WindowButtonStyle}"
                                Width="45"
                                x:Name="MinimizeButton" />
                            <Button
                                Click="MaximizeButton_Click"
                                Content="▢"
                                Focusable="True"
                                FontSize="16"
                                Height="36"
                                Style="{StaticResource WindowButtonStyle}"
                                Width="45"
                                x:Name="MaximizeButton" />
                            <Button
                                Click="CloseButton_Click"
                                Content="✕"
                                Focusable="True"
                                FontSize="16"
                                Height="36"
                                Style="{StaticResource CloseButtonStyle}"
                                Width="45"
                                x:Name="CloseButton" />
                        </StackPanel>

                        <!--  overlayed centered title so it's visually centered for the whole title bar  -->
                        <TextBlock
                            FontSize="14"
                            Foreground="#CCC"
                            Grid.Column="0"
                            Grid.ColumnSpan="3"
                            HorizontalAlignment="Center"
                            IsHitTestVisible="False"
                            Panel.ZIndex="20"
                            Text="十指禅"
                            VerticalAlignment="Center"
                            x:Name="TitleText" />
                    </Grid>
                </Border>
            </Grid>

            <Menu
                Background="{StaticResource MenuBackgroundBrush}"
                FontFamily="{StaticResource MenuFontFamily}"
                Foreground="White"
                Height="32"
                HorizontalAlignment="Stretch"
                Margin="0,38,0,0"
                Padding="{StaticResource MenuInnerPadding}"
                Panel.ZIndex="0"
                VerticalAlignment="Top"
                Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Window}}">
                <MenuItem Header="文件" Style="{StaticResource DarkMenuItemStyle}">
                    <MenuItem Click="ExitMenuItem_Click" Style="{StaticResource DarkSubMenuItemStyle}">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    Foreground="#FFA500"
                                    Margin="0,0,8,0"
                                    Text="🚪"
                                    VerticalAlignment="Center" />
                                <TextBlock Text="退出" VerticalAlignment="Center" />
                            </StackPanel>
                        </MenuItem.Header>
                    </MenuItem>
                </MenuItem>
                <MenuItem Header="设置" Style="{StaticResource DarkMenuItemStyle}">
                    <MenuItem Click="NameMenuItem_Click" Style="{StaticResource DarkSubMenuItemStyle}">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    Foreground="#4169E1"
                                    Margin="0,0,8,0"
                                    Text="👤"
                                    VerticalAlignment="Center" />
                                <TextBlock Text="姓名" VerticalAlignment="Center" />
                            </StackPanel>
                        </MenuItem.Header>
                    </MenuItem>
                    <MenuItem Click="TimingMenuItem_Click" Style="{StaticResource DarkSubMenuItemStyle}">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    Foreground="#00CED1"
                                    Margin="0,0,8,0"
                                    Text="⏱️"
                                    VerticalAlignment="Center" />
                                <TextBlock Text="计时" VerticalAlignment="Center" />
                            </StackPanel>
                        </MenuItem.Header>
                    </MenuItem>
                    <MenuItem Click="AnalysisMenuItem_Click" Style="{StaticResource DarkSubMenuItemStyle}">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    Foreground="#32CD32"
                                    Margin="0,0,8,0"
                                    Text="📊"
                                    VerticalAlignment="Center" />
                                <TextBlock Text="分析" VerticalAlignment="Center" />
                            </StackPanel>
                        </MenuItem.Header>
                    </MenuItem>
                </MenuItem>
                <MenuItem
                    Header="文本选择"
                    Style="{StaticResource DarkMenuItemStyle}"
                    x:Name="TextSelectionMenu">
                    <!--  动态填充  -->
                    <MenuItem
                        Header="(加载中...)"
                        IsEnabled="False"
                        Style="{StaticResource DarkSubMenuItemStyle}" />
                </MenuItem>
                <MenuItem Header="帮助" Style="{StaticResource DarkMenuItemStyle}">
                    <MenuItem Click="HelpMenuItem_Click" Style="{StaticResource DarkSubMenuItemStyle}">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    Foreground="#FFD700"
                                    Margin="0,0,8,0"
                                    Text="❓"
                                    VerticalAlignment="Center" />
                                <TextBlock Text="使用说明" VerticalAlignment="Center" />
                            </StackPanel>
                        </MenuItem.Header>
                    </MenuItem>
                    <MenuItem Click="AboutMenuItem_Click" Style="{StaticResource DarkSubMenuItemStyle}">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    Foreground="#87CEEB"
                                    Margin="0,0,8,0"
                                    Text="ℹ️"
                                    VerticalAlignment="Center" />
                                <TextBlock Text="关于" VerticalAlignment="Center" />
                            </StackPanel>
                        </MenuItem.Header>
                    </MenuItem>
                </MenuItem>
            </Menu>

            <Grid Margin="0,84,0,0">
                <!--  主内容区: 占位, 用户后续扩展内容  -->
                <Border
                    Background="#151515"
                    BorderThickness="2"
                    ClipToBounds="True"
                    CornerRadius="8"
                    Margin="50,75,50,25"
                    Padding="50px,0,50px,0">
                    <!--  Typing area: RichTextBox used to render per-character Runs so we can color them  -->
                    <!--  直接使用RichTextBox的内置滚动功能  -->
                    <RichTextBox
                        AcceptsReturn="False"
                        AcceptsTab="False"
                        Background="#151515"
                        BorderThickness="0"
                        FontFamily="{StaticResource MenuFontFamily}"
                        FontSize="24"
                        Foreground="#777"
                        HorizontalAlignment="Stretch"
                        HorizontalScrollBarVisibility="Disabled"
                        IsDocumentEnabled="True"
                        IsReadOnly="True"
                        MaxWidth="1250"
                        PreviewKeyDown="TypingDisplay_PreviewKeyDown"
                        PreviewTextInput="TypingDisplay_PreviewTextInput"
                        ScrollViewer.CanContentScroll="True"
                        ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                        ScrollViewer.VerticalScrollBarVisibility="Hidden"
                        SnapsToDevicePixels="True"
                        TextOptions.TextFormattingMode="Display"
                        UseLayoutRounding="True"
                        x:Name="TypingDisplay">
                        <FlowDocument>
                            <Paragraph />
                        </FlowDocument>
                    </RichTextBox>
                </Border>

                <!--  Tester name in top-right of main content area (below title/menu)  -->
                <TextBlock
                    FontFamily="{StaticResource MenuFontFamily}"
                    FontSize="14"
                    HorizontalAlignment="Right"
                    IsHitTestVisible="False"
                    Margin="0,30,55,0"
                    Panel.ZIndex="20"
                    VerticalAlignment="Top">
                    <Run Foreground="#AAA" Text="测试者" />
                    <Run Foreground="Gray" Text=":" />
                    <Run Foreground="#9DCBFF">
                        <Run.Text>
                            <Binding
                                FallbackValue="江湖人士"
                                Path="TesterName"
                                TargetNullValue="江湖人士" />
                        </Run.Text>
                    </Run>
                </TextBlock>
            </Grid>
        </Grid>
    </Border>
</Window>